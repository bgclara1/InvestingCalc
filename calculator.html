<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Investment Growth Projection</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      font-family: "Avenir Next", "Avenir", "Futura", "Trebuchet MS", sans-serif;
      color-scheme: light;
      --bg: #f5efe5;
      --bg-deep: #d9e3d6;
      --ink: #1f2622;
      --muted: #4d5a54;
      --card: #fbf8f1;
      --border: #d6cdc1;
      --accent: #2f6b4f;
      --accent-strong: #23543d;
      --soft: #f0ebe2;
      --input: #f6f1e8;
      --danger: #b84735;
      --chart-text: #1f2622;
      --chart-text-muted: #5a635e;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #f7f2e8 0%, #eef5ee 40%, #f5efe5 100%);
      color: var(--ink);
    }
    body::before,
    body::after {
      content: "";
      position: fixed;
      inset: -20% -10%;
      z-index: -1;
      background:
        radial-gradient(circle at 10% 20%, rgba(92, 158, 120, 0.28) 0%, rgba(92, 158, 120, 0) 42%),
        radial-gradient(circle at 30% 70%, rgba(178, 142, 98, 0.28) 0%, rgba(178, 142, 98, 0) 46%),
        radial-gradient(circle at 70% 35%, rgba(200, 127, 86, 0.28) 0%, rgba(200, 127, 86, 0) 40%),
        radial-gradient(circle at 85% 80%, rgba(120, 168, 116, 0.24) 0%, rgba(120, 168, 116, 0) 45%);
      filter: blur(0px);
      animation: floatBlobs 22s ease-in-out infinite;
      opacity: 0.9;
      pointer-events: none;
    }
    body::after {
      animation-duration: 30s;
      animation-direction: reverse;
      opacity: 0.65;
      filter: blur(2px);
    }
    @keyframes floatBlobs {
      0% { transform: translate3d(-2%, -1%, 0) scale(1); }
      50% { transform: translate3d(2%, 2%, 0) scale(1.05); }
      100% { transform: translate3d(-2%, -1%, 0) scale(1); }
    }
    .wrap { max-width: none; width: 100%; margin: 0; padding: 18px 24px 42px; box-sizing: border-box; }
    .appHeader {
      padding: 14px 16px 16px;
      margin-bottom: 6px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(251, 248, 241, 0.9);
      box-shadow: 0 14px 28px rgba(31, 38, 34, 0.08);
    }
    .topNav {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(251, 248, 241, 0.85);
      box-shadow: 0 10px 22px rgba(31, 38, 34, 0.08);
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--muted);
      flex-wrap: wrap;
    }
    .brand {
      font-weight: 700;
      color: var(--ink);
      letter-spacing: 1.2px;
      text-decoration: none;
    }
    .navActions {
      margin-left: auto;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .navLink {
      text-decoration: none;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      font-weight: 700;
      transition: background 150ms ease, color 150ms ease, border 150ms ease;
    }
    .navLink:hover { color: var(--ink); border-color: var(--border); background: #f7f2e9; }
    .navLink.primary { background: rgba(47, 107, 79, 0.12); color: var(--accent-strong); border-color: var(--border); }
    .appTitle { font-size: 20px; margin: 0 0 6px; font-weight: 700; letter-spacing: 0.2px; }
    .appIntro { font-size: 14px; color: var(--muted); line-height: 1.6; margin: 0; }
    .homeLink {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: rgba(47, 107, 79, 0.12);
      color: var(--accent-strong);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      border: 1px solid var(--border);
      transition: transform 150ms ease, background 150ms ease;
      margin-left: auto;
    }
    .homeLink:hover { transform: translateY(-1px); background: rgba(47, 107, 79, 0.2); }
    .homeLink svg { width: 22px; height: 22px; }

    .layout { display: grid; grid-template-columns: 180px 1fr; gap: 18px; align-items: start; }
    .toc {
      position: sticky;
      top: 24px;
      align-self: start;
      display: grid;
      gap: 8px;
      padding: 12px;
      background: rgba(251, 248, 241, 0.75);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(31, 38, 34, 0.08);
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--muted);
    }
    .toc button {
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 10px;
      padding: 8px 10px;
      text-align: left;
      font-weight: 700;
      cursor: pointer;
    }
    .toc button.active {
      color: var(--ink);
      border-color: var(--border);
      background: #f7f2e9;
    }

    .carouselScroll {
      position: relative;
    }
    .carouselStage {
      position: relative;
      height: calc(100vh - 120px);
      min-height: 760px;
      padding: 12px 6px 36px;
      position: sticky;
      top: 24px;
    }
    .carouselCard {
      position: absolute;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 18px 40px rgba(31, 38, 34, 0.08);
      transition: none;
      will-change: transform, opacity, filter, left, top, width;
      opacity: 0;
      pointer-events: none;
      overflow: visible;
    }
    .carouselCard .section { margin-top: 0; padding-top: 0; border-top: 0; }
    .carouselCard .section + .section { margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }

    .section { margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
    .section:first-of-type { margin-top: 0; padding-top: 0; border-top: 0; }

    .sectionTitle { font-size: 13px; color: var(--muted); margin: 0 0 6px; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 700; }
    .tiny { font-size: 12px; color: var(--muted); margin: 0 0 8px; line-height: 1.35; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--ink);
      box-sizing: border-box;
    }
    .moneyFieldWrap {
      position: relative;
      width: 100%;
      display: block;
    }
    .moneyFieldWrap::before {
      content: "£";
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
      pointer-events: none;
    }
    .moneyFieldWrap input {
      padding-left: 22px;
    }

    button { padding: 10px 14px; border-radius: 10px; border: 0; background: var(--accent); color: #fff; font-weight: 700; cursor: pointer; }
    button.secondary { background: #4f5b55; }
    button.danger { background: var(--danger); }

    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end; margin-top: 10px; }
    .note { font-size: 12px; color: var(--muted); line-height: 1.35; }
    .out { margin-top: 10px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; }

    .panel {
      background: var(--soft);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 10px;
    }
    .panel .out { margin-top: 0; }
    .insightGrid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .returnGrid {
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    .returnStack {
      display: grid;
      gap: 8px;
    }
    .insightCard.sub {
      background: #f1eadf;
      padding: 8px 10px;
    }
    .insightValue.sub {
      font-size: 13px;
      font-weight: 700;
    }
    .insightCard {
      background: #f7f2e9;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .insightLabel {
      font-size: 11px;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
      font-weight: 700;
    }
    .insightValue {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink);
    }
    .section.has-guide { position: relative; }
    .guide {
      background: rgba(47, 107, 79, 0.9);
      color: #fff;
      padding: 10px 12px;
      border-radius: 16px;
      font-size: 12px;
      line-height: 1.4;
      margin: 8px 0 14px;
      box-shadow: 0 10px 20px rgba(31, 38, 34, 0.12);
      position: static;
      width: auto;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 6px; font-size: 12px; }
    th { text-align: left; color: var(--muted); }
    td:last-child, th:last-child { text-align: right; }

    .chartWrap { margin-top: 12px; height: 320px; }
    .incomeChartWrap { margin-top: 12px; height: 340px; }
    canvas { width: 100% !important; height: 100% !important; background: #fcfaf6; border: 1px solid var(--border); border-radius: 14px; }

    .errorBox {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #c06055;
      background: #f6e2dc;
      color: #7c2319;
      display: none;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .badRow input {
      border-color: var(--danger) !important;
      box-shadow: 0 0 0 2px rgba(180, 71, 53, 0.2);
    }

    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
      button { width: 100%; }
      .chartWrap { height: 260px; }
      .incomeChartWrap { height: 260px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav class="topNav">
      <a class="brand" href="https://clarabollengandolfo.github.io/">Clara Bollen Gandolfo</a>
      <div class="navActions">
        <a class="navLink primary" href="calculator.html">Income-based investment calculator</a>
        <a class="navLink" href="goal-calculator.html">Financial goal based investment calculator</a>
        <a class="navLink" href="articles.html">Articles</a>
        <a class="homeLink" href="index.html" aria-label="Back to landing page">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 10.5L12 3l9 7.5" />
            <path d="M6.5 10.5V21h11V10.5" />
          </svg>
        </a>
      </div>
    </nav>
    <div class="appHeader">
      <h2 class="appTitle">Investment Growth Projection</h2>
      <p class="appIntro">
        Map your future income, estimate take-home pay, and test how different monthly contribution
        schedules compound over time. Compare downside and upside return scenarios, then adjust
        withdrawals to see how your plan holds up.
      </p>
    </div>

    <div class="layout">
      <nav class="toc" id="toc">
        <button type="button" data-step="0">Income + budget</button>
        <button type="button" data-step="1">Current income insights</button>
        <button type="button" data-step="2">Portfolio setup</button>
        <button type="button" data-step="3">Income path</button>
        <button type="button" data-step="4">Monthly leftover</button>
        <button type="button" data-step="5">Contrib + withdrawals</button>
        <button type="button" data-step="6">Return graph</button>
      </nav>

      <div class="carouselScroll" id="carouselScroll">
        <div class="carouselStage" id="carouselStage">
      <div class="carouselCard" data-step="0">
        <div class="section has-guide">
          <div class="sectionTitle">Income & monthly budget</div>
          <div class="guide">
            Start with your current gross salary and tax region. Add rent and living costs to estimate
            how much cash you have left each month.
          </div>
          <div class="tiny">
            Estimates take-home pay using Income Tax + employee National Insurance (UK 2025/26).
            Doesn’t include pension, student loan, benefits, etc.
          </div>

          <div class="grid">
            <div>
            <label for="grossIncome">Annual gross income</label>
            <span class="moneyFieldWrap">
              <input id="grossIncome" type="number" min="0" step="500" value="60000" />
            </span>
            </div>
            <div>
              <label for="taxRegion">Tax region</label>
              <select id="taxRegion">
                <option value="rUK" selected>England / Wales / Northern Ireland</option>
                <option value="SCO">Scotland</option>
              </select>
            </div>
          </div>

          <div class="grid" style="margin-top:10px;">
            <div>
            <label for="rentMonthly">Monthly rent</label>
            <span class="moneyFieldWrap">
              <input id="rentMonthly" type="number" min="0" step="50" value="1500" />
            </span>
            </div>
            <div>
            <label for="livingMonthly">Monthly living costs</label>
            <span class="moneyFieldWrap">
              <input id="livingMonthly" type="number" min="0" step="50" value="900" />
            </span>
            </div>
          </div>
        </div>
      </div>

      <div class="carouselCard" data-step="1">
        <div class="section has-guide">
          <div class="sectionTitle">Insights</div>
          <div class="guide">
            Use this button if you want a clean recalculation after edits. The output updates live too,
            so consider it a quick refresh.
          </div>
          <div class="insightGrid">
            <div class="insightCard">
              <div class="insightLabel">Net annual income</div>
              <div id="insightNetAnnual" class="insightValue">—</div>
            </div>
            <div class="insightCard">
              <div class="insightLabel">Net monthly income</div>
              <div id="insightNetMonthly" class="insightValue">—</div>
            </div>
            <div class="insightCard">
              <div class="insightLabel">Total expenses per month</div>
              <div id="insightExpenses" class="insightValue">—</div>
            </div>
            <div class="insightCard">
              <div class="insightLabel">Leftover per month</div>
              <div id="insightLeftover" class="insightValue">—</div>
            </div>
          </div>

          <div class="panel">
            <div id="incomeDetails" class="out"></div>
          </div>
        </div>
      </div>

      <div class="carouselCard" data-step="2">
        <div class="section has-guide">
          <div class="sectionTitle">Portfolio setup</div>
          <div class="guide">
            Enter your current invested balance and how many years you want to simulate. Longer horizons
            will show more compounding over time.
          </div>
          <div class="tiny">Starting pot is your current invested value. Projection is how many years to simulate.</div>

          <div class="grid">
            <div>
            <label for="start">Starting pot</label>
            <span class="moneyFieldWrap">
              <input id="start" type="number" min="0" step="100" value="10000" />
            </span>
            </div>
            <div>
              <label for="years">Projection (years)</label>
              <input id="years" type="number" min="1" step="1" value="30" />
            </div>
          </div>
        </div>
      </div>

      <div class="carouselCard" data-step="3">
        <div class="section has-guide">
          <div class="sectionTitle">Projected income path</div>
          <div class="guide">
            Drag each 5‑year dot to sketch how your salary might grow. This becomes the backbone for
            your contribution plan later.
          </div>
          <div class="tiny">
            Drag the dots (every 5 years) to sketch your future gross salary. The chart runs from 0-200,000 GBP.
          </div>
          <div class="incomeChartWrap"><canvas id="incomeChart"></canvas></div>
        </div>
      </div>

      <div class="carouselCard" data-step="4">
        <div class="section has-guide">
          <div class="sectionTitle">Monthly leftover at each point</div>
          <div class="guide">
            Review how much you can invest at each milestone. If the leftover looks too tight, go back
            and adjust income or expenses.
          </div>
          <table>
            <thead>
              <tr>
                <th style="width: 18%;">Year</th>
                <th>Gross annual</th>
                <th>Net monthly</th>
                <th>Leftover monthly</th>
              </tr>
            </thead>
            <tbody id="incomeProjectionBody"></tbody>
          </table>
          <div class="row" style="margin-top: 12px;">
            <div class="note">Use your projected leftover to fill the contribution schedule.</div>
            <button id="applyIncomeToContrib" type="button">Auto-fill contribution schedule</button>
          </div>
        </div>
      </div>

      <div class="carouselCard" data-step="5">
        <div class="section has-guide">
          <div class="sectionTitle">Monthly contribution schedule</div>
          <div class="guide">
            Add ranges that match your projected phases. Later rows override earlier ones if they overlap,
            so you can refine your plan without deleting old entries.
          </div>
          <div class="tiny">Ranges are <b>start-inclusive</b>, <b>end-exclusive</b>. Later rows override earlier rows if they overlap.</div>

          <table>
            <thead>
              <tr>
                <th style="width: 20%;">From year</th>
                <th style="width: 20%;">To year</th>
                <th>Monthly contribution</th>
                <th style="width: 120px;"></th>
              </tr>
            </thead>
            <tbody id="schedBody"></tbody>
          </table>
          <div class="row">
            <div class="note">Add or remove contribution phases as your plan changes.</div>
            <button id="addRow" class="secondary" type="button">Add contrib row</button>
          </div>
        </div>

        <div class="section has-guide">
          <div class="sectionTitle">Lump sum withdrawals</div>
          <div class="guide">
            Add any big future expenses like a deposit or tuition. These are applied at the end of the year
            you select.
          </div>
          <div class="tiny">
            Enter a year (whole number). Withdrawal is applied at the <b>end of that year</b>.
            Amount is positive (money removed).
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 20%;">Year</th>
                <th>Withdrawal amount</th>
                <th style="width: 120px;"></th>
              </tr>
            </thead>
            <tbody id="wBody"></tbody>
          </table>
          <div class="row">
            <div class="note">Add future withdrawals to stress‑test your plan.</div>
            <button id="addW" class="secondary" type="button">Add withdrawal</button>
          </div>

          <div id="errors" class="errorBox"></div>
        </div>
      </div>

      <div class="carouselCard" data-step="6">
        <div class="section has-guide">
          <div class="guide">
            Run the model to compare bad, average, and good return paths. Use the chart to sanity‑check
            whether your plan meets your target timeframe.
          </div>
          <div class="insightGrid returnGrid">
            <div class="returnStack">
              <div class="insightCard">
                <div class="insightLabel">Good market return</div>
                <div id="returnGood" class="insightValue">—</div>
              </div>
              <div class="insightCard sub">
                <div class="insightLabel">Delta vs contribution</div>
                <div id="returnGoodDelta" class="insightValue sub">—</div>
              </div>
            </div>
            <div class="returnStack">
              <div class="insightCard">
                <div class="insightLabel">Average market return</div>
                <div id="returnAverage" class="insightValue">—</div>
              </div>
              <div class="insightCard sub">
                <div class="insightLabel">Delta vs contribution</div>
                <div id="returnAverageDelta" class="insightValue sub">—</div>
              </div>
            </div>
            <div class="returnStack">
              <div class="insightCard">
                <div class="insightLabel">Poor market return</div>
                <div id="returnBad" class="insightValue">—</div>
              </div>
              <div class="insightCard sub">
                <div class="insightLabel">Delta vs contribution</div>
                <div id="returnBadDelta" class="insightValue sub">—</div>
              </div>
            </div>
            <div class="returnStack">
              <div class="insightCard">
                <div class="insightLabel">Net contributed</div>
                <div id="returnNetContrib" class="insightValue">—</div>
              </div>
              <div class="insightCard sub">
                <div class="insightLabel">Total withdrawn</div>
                <div id="returnWithdrawn" class="insightValue sub">—</div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="note">
              Assumed annual returns: <b>Bad 3%</b>, <b>Average 7%</b>, <b>Good 10%</b>.
              Monthly compounding. Plot shows yearly points for speed.
            </div>
            <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
              <button id="run" type="button">Run</button>
            </div>
          </div>

          <div id="output" class="out"></div>
          <div class="chartWrap"><canvas id="chart"></canvas></div>
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>

  <script>
    const scenarios = [
      { name: "Bad (3%/yr)", annual: 0.03 },
      { name: "Average (7%/yr)", annual: 0.07 },
      { name: "Good (10%/yr)", annual: 0.10 },
    ];

    function annualToMonthlyRate(annualReturn) {
      return Math.pow(1 + annualReturn, 1/12) - 1;
    }

    function fmtMoney(x) {
      const n = Number(x);
      if (!Number.isFinite(n)) return "£0";
      return "£" + n.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }

    function fmtCompact(x) {
      const ax = Math.abs(x);
      if (ax >= 1e9) return "£" + (x/1e9).toFixed(1) + "b";
      if (ax >= 1e6) return "£" + (x/1e6).toFixed(1) + "m";
      if (ax >= 1e3) return "£" + (x/1e3).toFixed(1) + "k";
      return "£" + String(Math.round(x));
    }

    function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }

    function calcPersonalAllowance(gross) {
      const PA0 = 12570;
      if (gross <= 100000) return PA0;
      const reduced = PA0 - (gross - 100000) / 2;
      return clamp(reduced, 0, PA0);
    }

    function taxByBands(taxable, bands) {
      let remaining = taxable;
      let prev = 0;
      let tax = 0;
      for (const b of bands) {
        const bandSize = (b.upTo === Infinity) ? remaining : Math.max(0, b.upTo - prev);
        const inBand = Math.max(0, Math.min(remaining, bandSize));
        tax += inBand * b.rate;
        remaining -= inBand;
        prev = b.upTo;
        if (remaining <= 0) break;
      }
      return tax;
    }

    function calcIncomeTax(gross, region) {
      const PA = calcPersonalAllowance(gross);
      const taxable = Math.max(0, gross - PA);

      if (region === "SCO") {
        const bands = [
          { upTo: (15397 - 12570), rate: 0.19 },
          { upTo: (27491 - 12570), rate: 0.20 },
          { upTo: (43662 - 12570), rate: 0.21 },
          { upTo: (75000 - 12570), rate: 0.42 },
          { upTo: (125140 - 12570), rate: 0.45 },
          { upTo: Infinity, rate: 0.48 },
        ];
        return taxByBands(taxable, bands);
      } else {
        const bands = [
          { upTo: (50270 - 12570), rate: 0.20 },
          { upTo: (125140 - 12570), rate: 0.40 },
          { upTo: Infinity, rate: 0.45 },
        ];
        return taxByBands(taxable, bands);
      }
    }

    function calcEmployeeNI(grossAnnual) {
      const PT = 242 * 52;   // 12,584
      const UEL = 967 * 52;  // 50,284
      if (grossAnnual <= PT) return 0;
      const mainBand = Math.min(grossAnnual, UEL) - PT;
      const upperBand = Math.max(0, grossAnnual - UEL);
      return mainBand * 0.08 + upperBand * 0.02;
    }

    function calcNetIncome(gross, region) {
      const incomeTax = calcIncomeTax(gross, region);
      const ni = calcEmployeeNI(gross);
      const net = gross - incomeTax - ni;
      return { net, incomeTax, ni };
    }

    function renderIncome() {
      const gross = Number(document.getElementById("grossIncome").value);
      const region = document.getElementById("taxRegion").value;
      const rent = Number(document.getElementById("rentMonthly").value);
      const living = Number(document.getElementById("livingMonthly").value);

      const details = document.getElementById("incomeDetails");
      const netAnnualEl = document.getElementById("insightNetAnnual");
      const netMonthlyEl = document.getElementById("insightNetMonthly");
      const expensesEl = document.getElementById("insightExpenses");
      const leftoverEl = document.getElementById("insightLeftover");

      function setInsights(netAnnual, netMonthly, expenses, leftover) {
        netAnnualEl.textContent = netAnnual;
        netMonthlyEl.textContent = netMonthly;
        expensesEl.textContent = expenses;
        leftoverEl.textContent = leftover;
      }

      if (!Number.isFinite(gross) || gross < 0) {
        setInsights("—", "—", "—", "—");
        details.textContent = "Enter a valid non-negative annual gross income.";
        return;
      }
      if (!Number.isFinite(rent) || rent < 0 || !Number.isFinite(living) || living < 0) {
        setInsights("—", "—", "—", "—");
        details.textContent = "Enter valid non-negative monthly rent and living costs.";
        return;
      }

      const { net, incomeTax, ni } = calcNetIncome(gross, region);
      const netMonthly = net / 12;

      const expensesMonthly = rent + living;
      const leftoverMonthly = netMonthly - expensesMonthly;

      setInsights(
        fmtMoney(net),
        fmtMoney(netMonthly),
        fmtMoney(expensesMonthly),
        fmtMoney(leftoverMonthly)
      );

      details.textContent =
        `Gross annual: ${fmtMoney(gross)}\n` +
        `Income Tax (est): ${fmtMoney(incomeTax)}\n` +
        `Employee NI (est): ${fmtMoney(ni)}\n` +
        `Net annual (est): ${fmtMoney(net)}\n\n` +
        `Monthly rent: ${fmtMoney(rent)}\n` +
        `Monthly living costs: ${fmtMoney(living)}\n` +
        `Total monthly expenses: ${fmtMoney(expensesMonthly)}`;
    }

    // ---------- UI row builders ----------
    function addContribRow(from=0, to=3, monthly=500) {
      const tbody = document.getElementById("schedBody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="number" min="0" step="1" value="${from}" data-field="from"></td>
        <td><input type="number" min="0" step="1" value="${to}" data-field="to"></td>
        <td><span class="moneyFieldWrap"><input type="number" min="0" step="50" value="${monthly}" data-field="monthly"></span></td>
        <td><button type="button" class="danger">Remove</button></td>
      `;
      tr.querySelector("button").addEventListener("click", () => { tr.remove(); validateUI(); });
      tr.querySelectorAll("input").forEach(inp => { inp.addEventListener("input", validateUI); inp.addEventListener("change", validateUI); });
      tbody.appendChild(tr);
      validateUI();
    }

    function addWithdrawalRow(year=5, amount=20000) {
      const tbody = document.getElementById("wBody");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="number" min="0" step="1" value="${year}" data-field="year"></td>
        <td><span class="moneyFieldWrap"><input type="number" min="0" step="100" value="${amount}" data-field="amount"></span></td>
        <td><button type="button" class="danger">Remove</button></td>
      `;
      tr.querySelector("button").addEventListener("click", () => { tr.remove(); validateUI(); });
      tr.querySelectorAll("input").forEach(inp => { inp.addEventListener("input", validateUI); inp.addEventListener("change", validateUI); });
      tbody.appendChild(tr);
      validateUI();
    }

    // ---------- Read rows ----------
    function readContribRowsWithEls() {
      const rows = [...document.querySelectorAll("#schedBody tr")];
      return rows.map(tr => {
        const fromEl = tr.querySelector('input[data-field="from"]');
        const toEl = tr.querySelector('input[data-field="to"]');
        const monthlyEl = tr.querySelector('input[data-field="monthly"]');
        return { tr, fromEl, toEl, monthlyEl,
          from: Number(fromEl.value), to: Number(toEl.value), monthly: Number(monthlyEl.value)
        };
      });
    }

    function readWithdrawalRowsWithEls() {
      const rows = [...document.querySelectorAll("#wBody tr")];
      return rows.map(tr => {
        const yearEl = tr.querySelector('input[data-field="year"]');
        const amountEl = tr.querySelector('input[data-field="amount"]');
        return { tr, yearEl, amountEl,
          year: Number(yearEl.value), amount: Number(amountEl.value)
        };
      });
    }

    // ---------- Validation ----------
    function validateAll(contribRows, wRows, years) {
      const errors = [];
      contribRows.forEach(r => r.tr.classList.remove("badRow"));
      wRows.forEach(r => r.tr.classList.remove("badRow"));

      if (!Number.isFinite(years) || years < 1 || years > 80) errors.push(`Projection years must be between 1 and 80.`);
      if (contribRows.length === 0) errors.push("Add at least one contribution schedule row.");

      contribRows.forEach((r, idx) => {
        const rowNum = idx + 1;

        if (!Number.isFinite(r.from) || !Number.isFinite(r.to) || !Number.isFinite(r.monthly)) { errors.push(`Contribution row ${rowNum}: values must be numbers.`); r.tr.classList.add("badRow"); return; }
        if (!Number.isInteger(r.from) || !Number.isInteger(r.to)) { errors.push(`Contribution row ${rowNum}: from/to years must be whole numbers.`); r.tr.classList.add("badRow"); }
        if (r.from < 0 || r.to < 0) { errors.push(`Contribution row ${rowNum}: years cannot be negative.`); r.tr.classList.add("badRow"); }
        if (r.to <= r.from) { errors.push(`Contribution row ${rowNum}: "To year" must be greater than "From year".`); r.tr.classList.add("badRow"); }
        if (r.from >= years) { errors.push(`Contribution row ${rowNum}: "From year" must be less than projection (${years}).`); r.tr.classList.add("badRow"); }
        if (r.to > years) { errors.push(`Contribution row ${rowNum}: "To year" cannot exceed projection (${years}).`); r.tr.classList.add("badRow"); }
        if (r.monthly < 0) { errors.push(`Contribution row ${rowNum}: monthly contribution cannot be negative.`); r.tr.classList.add("badRow"); }
      });

      wRows.forEach((r, idx) => {
        const rowNum = idx + 1;

        if (!Number.isFinite(r.year) || !Number.isFinite(r.amount)) { errors.push(`Withdrawal row ${rowNum}: values must be numbers.`); r.tr.classList.add("badRow"); return; }
        if (!Number.isInteger(r.year)) { errors.push(`Withdrawal row ${rowNum}: year must be a whole number.`); r.tr.classList.add("badRow"); }
        if (r.year < 0 || r.year > years) { errors.push(`Withdrawal row ${rowNum}: year must be between 0 and ${years}.`); r.tr.classList.add("badRow"); }
        if (r.amount < 0) { errors.push(`Withdrawal row ${rowNum}: withdrawal amount cannot be negative.`); r.tr.classList.add("badRow"); }
      });

      return { ok: errors.length === 0, errors };
    }

    // ---------- Build cashflow schedules ----------
    function buildContribByMonth(contribRows, years) {
      const months = years * 12;
      const contribByMonth = new Array(months).fill(0);

      const sorted = contribRows
        .map(r => ({ from: r.from, to: r.to, monthly: r.monthly }))
        .sort((a,b) => a.from - b.from);

      for (const s of sorted) {
        const startM = s.from * 12;
        const endM = s.to * 12;
        for (let m = startM; m < endM; m++) contribByMonth[m] = s.monthly;
      }
      return contribByMonth;
    }

    function buildWithdrawalsByYearEnd(wRows, years) {
      const arr = new Array(years + 1).fill(0);
      for (const r of wRows) arr[r.year] += r.amount;
      return arr;
    }

    // ---------- Simulation ----------
    function simulateYearly(startingPot, contribByMonth, withdrawalsByYearEnd, annualReturn, years) {
      const months = years * 12;
      const r = annualToMonthlyRate(annualReturn);

      let v = startingPot;
      v -= (withdrawalsByYearEnd[0] ?? 0); // immediate year-0 withdrawal

      const yearly = [v];

      for (let m = 1; m <= months; m++) {
        const c = contribByMonth[m - 1] ?? 0;
        v = v * (1 + r) + c;

        if (m % 12 === 0) {
          const year = m / 12;
          v -= (withdrawalsByYearEnd[year] ?? 0);
          yearly.push(v);
        }
      }
      return yearly;
    }

    function contributedNetYearly(startingPot, contribByMonth, withdrawalsByYearEnd, years) {
      const months = years * 12;
      let total = startingPot - (withdrawalsByYearEnd[0] ?? 0);
      const yearly = [total];

      for (let m = 1; m <= months; m++) {
        total += (contribByMonth[m - 1] ?? 0);
        if (m % 12 === 0) {
          const year = m / 12;
          total -= (withdrawalsByYearEnd[year] ?? 0);
          yearly.push(total);
        }
      }
      return yearly;
    }

    // ---------- Chart ----------
    const errorsEl = document.getElementById("errors");
    const runBtn = document.getElementById("run");
    const ctx = document.getElementById("chart");
    let chart = null;
    const rootStyles = getComputedStyle(document.documentElement);
    const chartText = rootStyles.getPropertyValue("--chart-text").trim() || "#1f2622";
    const chartTextMuted = rootStyles.getPropertyValue("--chart-text-muted").trim() || "#5a635e";
    const carouselCards = [...document.querySelectorAll(".carouselCard")];
    const carouselScroll = document.getElementById("carouselScroll");
    const carouselStage = document.getElementById("carouselStage");
    const tocButtons = [...document.querySelectorAll("#toc button")];
    const incomeYears = [0, 5, 10, 15, 20, 25, 30];
    const incomeBody = document.getElementById("incomeProjectionBody");
    const incomeCanvas = document.getElementById("incomeChart");
    let incomeChart = null;
    let incomePoints = [];
    let incomeDragIndex = null;

    function lerp(a, b, t) { return a + (b - a) * t; }

    function renderCarousel(progress) {
      const rect = carouselStage.getBoundingClientRect();
      const stageW = rect.width;
      const stageH = rect.height;

      const centerLeft = 0.14 * stageW;
      const center = { left: centerLeft, top: 60, width: 0.72 * stageW, opacity: 1, blur: 0, z: 3 };
      const prev = { left: centerLeft, top: 0, width: 0.72 * stageW, opacity: 0.45, blur: 0.6, z: 1 };
      const next = { left: centerLeft, top: stageH * 0.62, width: 0.72 * stageW, opacity: 0.45, blur: 0.6, z: 2 };

      carouselCards.forEach((card, idx) => {
        const offset = idx - progress;
        if (Math.abs(offset) > 1.2) {
          card.style.opacity = "0";
          card.style.pointerEvents = "none";
          return;
        }

        let from = center;
        let to = center;
        let t = 0;

        if (offset <= 0) {
          from = prev;
          to = center;
          t = clamp(offset + 1, 0, 1);
        } else {
          from = center;
          to = next;
          t = clamp(offset, 0, 1);
        }

        const left = lerp(from.left, to.left, t);
        const top = lerp(from.top, to.top, t);
        const width = lerp(from.width, to.width, t);
        const opacity = lerp(from.opacity, to.opacity, t);
        const blur = lerp(from.blur, to.blur, t);
        const z = offset < 0 ? 1 : 2;

        card.style.left = `${left}px`;
        card.style.top = `${top}px`;
        card.style.width = `${width}px`;
        card.style.opacity = opacity.toFixed(3);
        card.style.filter = `blur(${blur.toFixed(2)}px)`;
        card.style.zIndex = offset === 0 ? "3" : String(z);
        card.style.pointerEvents = Math.abs(offset) < 0.15 ? "auto" : "none";
      });

      const activeIdx = Math.round(progress);
      tocButtons.forEach((btn) => {
        btn.classList.toggle("active", Number(btn.dataset.step) === activeIdx);
      });
    }

    function updateCarouselScrollHeight() {
      carouselScroll.style.height = `${carouselCards.length * 80}vh`;
    }

    function scrollToCarouselIndex(index) {
      const rect = carouselScroll.getBoundingClientRect();
      const usable = rect.height - window.innerHeight;
      if (usable <= 0) return;
      const start = carouselScroll.offsetTop;
      const target = start + (usable * (index / (carouselCards.length - 1)));
      window.scrollTo({ top: target, behavior: "smooth" });
    }

    let scrollTicking = false;
    let scrollSnapTimer = null;
    function handleScroll() {
      if (scrollTicking) return;
      scrollTicking = true;
      requestAnimationFrame(() => {
        const rect = carouselScroll.getBoundingClientRect();
        const usable = rect.height - window.innerHeight;
        if (usable > 0) {
          const start = carouselScroll.offsetTop;
          const progress = clamp((window.scrollY - start) / usable, 0, 1);
          let indexProgress = progress * (carouselCards.length - 1);
          const snapped = Math.round(indexProgress);
          if (Math.abs(indexProgress - snapped) < 0.12) {
            indexProgress = snapped;
          }
          renderCarousel(indexProgress);
        }
        scrollTicking = false;
      });

      if (scrollSnapTimer) clearTimeout(scrollSnapTimer);
      scrollSnapTimer = setTimeout(() => {
        if (window.scrollY < 80) {
          window.scrollTo({ top: 0, behavior: "smooth" });
          return;
        }
        const rect = carouselScroll.getBoundingClientRect();
        const usable = rect.height - window.innerHeight;
        if (usable <= 0) return;
        const start = carouselScroll.offsetTop;
        const progress = clamp((window.scrollY - start) / usable, 0, 1);
        const targetIndex = Math.round(progress * (carouselCards.length - 1));
        scrollToCarouselIndex(targetIndex);
      }, 100);
    }

    function seedIncomePoints(base) {
      return incomeYears.map((y) => ({
        x: y,
        y: clamp(Math.round(base * Math.pow(1.03, y)), 0, 200000)
      }));
    }

    function updateIncomeProjectionTable() {
      const rent = Number(document.getElementById("rentMonthly").value);
      const living = Number(document.getElementById("livingMonthly").value);
      const expensesMonthly = rent + living;

      incomeBody.innerHTML = "";

      incomePoints.forEach((p) => {
        const { net } = calcNetIncome(p.y, document.getElementById("taxRegion").value);
        const netMonthly = net / 12;
        const leftover = netMonthly - expensesMonthly;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${p.x}</td>
          <td>${fmtMoney(p.y)}</td>
          <td>${fmtMoney(netMonthly)}</td>
          <td>${fmtMoney(leftover)}</td>
        `;
        incomeBody.appendChild(row);
      });
    }

    function initIncomeChart() {
      const base = Number(document.getElementById("grossIncome").value) || 60000;
      incomePoints = seedIncomePoints(base);

      incomeChart = new Chart(incomeCanvas, {
        type: "line",
        data: {
          datasets: [{
            label: "Projected gross income",
            data: incomePoints,
            borderWidth: 2,
            borderColor: "#1f5b3f",
            pointBackgroundColor: "#1f5b3f",
            pointBorderColor: "#143f2b",
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.2
          }]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: chartText } }
          },
          scales: {
            x: {
              type: "linear",
              min: 0,
              max: 30,
              ticks: { color: chartTextMuted, stepSize: 5 },
              title: { display: true, text: "Years", color: chartText }
            },
            y: {
              min: 0,
              max: 200000,
              ticks: { color: chartTextMuted, callback: (v) => fmtMoney(v) },
              title: { display: true, text: "Gross annual income (GBP)", color: chartText }
            }
          }
        }
      });

      updateIncomeProjectionTable();
    }

    function setIncomePoint(index, value) {
      const clamped = clamp(Math.round(value), 0, 200000);
      incomePoints[index].y = clamped;

      if (index === 0) {
        const grossInput = document.getElementById("grossIncome");
        grossInput.value = clamped;
        renderIncome();
      }

      if (incomeChart) {
        incomeChart.update("none");
      }
      updateIncomeProjectionTable();
    }

    function monthlyLeftoverForGross(grossAnnual) {
      const rent = Number(document.getElementById("rentMonthly").value);
      const living = Number(document.getElementById("livingMonthly").value);
      const { net } = calcNetIncome(grossAnnual, document.getElementById("taxRegion").value);
      return (net / 12) - (rent + living);
    }

    function applyIncomeToContribSchedule() {
      const years = Math.floor(Number(document.getElementById("years").value) || 30);
      const tbody = document.getElementById("schedBody");
      tbody.innerHTML = "";

      for (let i = 0; i < incomePoints.length - 1; i++) {
        const from = incomePoints[i].x;
        const to = incomePoints[i + 1].x;
        if (from >= years) break;
        const cappedTo = Math.min(to, years);
        const leftover = monthlyLeftoverForGross(incomePoints[i].y);
        const monthly = Math.max(0, Math.round(leftover));
        addContribRow(from, cappedTo, monthly);
      }
      run();
    }

    function handleIncomePointerDown(evt) {
      const points = incomeChart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
      if (!points.length) return;
      const idx = points[0].index;
      if (idx == null) return;
      incomeDragIndex = idx;
    }

    function handleIncomePointerMove(evt) {
      if (incomeDragIndex == null) return;
      const yVal = incomeChart.scales.y.getValueForPixel(evt.offsetY);
      setIncomePoint(incomeDragIndex, yVal);
    }

    function handleIncomePointerUp() {
      incomeDragIndex = null;
    }

    function validateUI() {
      const years = Math.floor(Number(document.getElementById("years").value));
      const contribRows = readContribRowsWithEls();
      const wRows = readWithdrawalRowsWithEls();

      const v = validateAll(contribRows, wRows, years);

      if (!v.ok) {
        errorsEl.style.display = "block";
        errorsEl.textContent = "Fix these before running:\n- " + v.errors.join("\n- ");
        runBtn.disabled = true;
        runBtn.style.opacity = 0.6;
        return false;
      } else {
        errorsEl.style.display = "none";
        errorsEl.textContent = "";
        runBtn.disabled = false;
        runBtn.style.opacity = 1;
        return true;
      }
    }

    function run() {
      if (!validateUI()) return;

      const startingPot = Number(document.getElementById("start").value);
      const years = Math.floor(Number(document.getElementById("years").value));

      if (!Number.isFinite(startingPot) || startingPot < 0) {
        errorsEl.style.display = "block";
        errorsEl.textContent = "Starting pot must be a valid non-negative number.";
        return;
      }

      const contribRows = readContribRowsWithEls();
      const wRows = readWithdrawalRowsWithEls();

      const contribByMonth = buildContribByMonth(contribRows, years);
      const withdrawalsByYearEnd = buildWithdrawalsByYearEnd(wRows, years);

      const labels = Array.from({ length: years + 1 }, (_, y) => y);
      const netContribYearly = contributedNetYearly(startingPot, contribByMonth, withdrawalsByYearEnd, years);

      const datasets = scenarios.map(s => ({
        label: s.name,
        data: simulateYearly(startingPot, contribByMonth, withdrawalsByYearEnd, s.annual, years),
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.15
      }));

      datasets.push({
        label: "Net Contributed (after withdrawals)",
        data: netContribYearly,
        borderWidth: 2,
        pointRadius: 0,
        borderDash: [8, 6],
        tension: 0.0
      });

      const totalMonthlyContrib = contribByMonth.reduce((a, b) => a + (Number.isFinite(b) ? b : 0), 0);
      const totalContribGross = startingPot + totalMonthlyContrib;
      const totalWithdrawn = withdrawalsByYearEnd.reduce((a, b) => a + (Number.isFinite(b) ? b : 0), 0);
      const totalContribNet = totalContribGross - totalWithdrawn;

      let text = `Horizon: ${years} years\n`;
      text += `Starting pot: ${fmtMoney(startingPot)}\n`;
      text += `Monthly contributions total: ${fmtMoney(totalMonthlyContrib)}\n`;
      text += `Total contributed (gross): ${fmtMoney(totalContribGross)}\n`;
      text += `Total withdrawn: ${fmtMoney(totalWithdrawn)}\n`;
      text += `Net contributed: ${fmtMoney(totalContribNet)}\n\n`;
      text += `Ending portfolio values:\n`;

      scenarios.forEach((s, idx) => {
        const endVal = datasets[idx].data[years];
        const gain = endVal - totalContribNet;
        text += `  ${s.name}: ${fmtMoney(endVal)} (Gain vs net contrib: ${fmtMoney(gain)})\n`;
      });

      document.getElementById("output").textContent = text;
      const badEnd = datasets[0].data[years];
      const avgEnd = datasets[1].data[years];
      const goodEnd = datasets[2].data[years];
      const badGain = badEnd - totalContribNet;
      const avgGain = avgEnd - totalContribNet;
      const goodGain = goodEnd - totalContribNet;

      document.getElementById("returnBad").textContent = fmtMoney(badEnd);
      document.getElementById("returnAverage").textContent = fmtMoney(avgEnd);
      document.getElementById("returnGood").textContent = fmtMoney(goodEnd);
      document.getElementById("returnBadDelta").textContent = (badGain >= 0 ? "+" : "") + fmtMoney(badGain);
      document.getElementById("returnAverageDelta").textContent = (avgGain >= 0 ? "+" : "") + fmtMoney(avgGain);
      document.getElementById("returnGoodDelta").textContent = (goodGain >= 0 ? "+" : "") + fmtMoney(goodGain);
      document.getElementById("returnNetContrib").textContent = fmtMoney(totalContribNet);
      document.getElementById("returnWithdrawn").textContent = fmtMoney(totalWithdrawn);

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { labels: { color: chartText } },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${fmtMoney(item.parsed.y)}` } }
          },
          scales: {
            x: { title: { display: true, text: "Years", color: chartText }, ticks: { color: chartTextMuted } },
            y: { title: { display: true, text: "Value", color: chartText }, ticks: { color: chartTextMuted, callback: (v) => fmtCompact(v) } }
          }
        }
      });
    }

    // ---------- Wire up ----------
    document.getElementById("addRow").addEventListener("click", () => {
      const years = Math.floor(Number(document.getElementById("years").value) || 30);
      const contribRows = readContribRowsWithEls().map(r => ({ to: r.to }));
      const maxTo = contribRows.reduce((mx, r) => Number.isFinite(r.to) ? Math.max(mx, r.to) : mx, 0);
      const from = Math.min(Math.max(0, Math.floor(maxTo)), years - 1);
      const to = Math.min(years, from + 5);
      addContribRow(from, to, 500);
    });

    document.getElementById("addW").addEventListener("click", () => {
      const years = Math.floor(Number(document.getElementById("years").value) || 30);
      addWithdrawalRow(Math.min(5, years), 20000);
    });

    document.getElementById("run").addEventListener("click", run);
    document.getElementById("years").addEventListener("input", validateUI);

    document.getElementById("grossIncome").addEventListener("input", () => {
      renderIncome();
      if (incomePoints.length) setIncomePoint(0, Number(document.getElementById("grossIncome").value));
    });
    document.getElementById("rentMonthly").addEventListener("input", () => {
      renderIncome();
      updateIncomeProjectionTable();
    });
    document.getElementById("livingMonthly").addEventListener("input", () => {
      renderIncome();
      updateIncomeProjectionTable();
    });
    document.getElementById("taxRegion").addEventListener("change", () => {
      renderIncome();
      updateIncomeProjectionTable();
    });

    incomeCanvas.addEventListener("pointerdown", handleIncomePointerDown);
    incomeCanvas.addEventListener("pointermove", handleIncomePointerMove);
    incomeCanvas.addEventListener("pointerup", handleIncomePointerUp);
    incomeCanvas.addEventListener("pointerleave", handleIncomePointerUp);
    document.getElementById("applyIncomeToContrib").addEventListener("click", applyIncomeToContribSchedule);
    // Defaults
    addContribRow(0, 3, 800);
    addContribRow(3, 10, 1100);
    addContribRow(10, 20, 2000);
    addContribRow(20, 30, 2000);

    addWithdrawalRow(7, 50000);

    renderIncome();
    initIncomeChart();
    validateUI();
    run();
    updateCarouselScrollHeight();
    handleScroll();
    window.addEventListener("scroll", handleScroll, { passive: true });
    window.addEventListener("resize", () => {
      updateCarouselScrollHeight();
      handleScroll();
    });
    tocButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        scrollToCarouselIndex(Number(btn.dataset.step));
      });
    });
  </script>
</body>
</html>
